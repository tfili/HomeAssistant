alarm_wrapper:
  homeassistant:
    customize:
      package.node_anchors:
        customize: &customize
          package: "alarm_wrapper"

      alarm_control_panel.alarm:
        <<: *customize
        code_format: null
        icon: "mdi:security"

      input_text.alarm_state:
        <<: *customize

  template:
    - alarm_control_panel:
        - unique_id: wrapped_alarm
          name: Alarm
          code_arm_required: false
          state: '{{ states("input_text.alarm_state") }}'
          arm_away:
            - action: alarm_control_panel.alarm_arm_away
              target:
                entity_id: alarm_control_panel.abode_alarm
          arm_home:
            - action: alarm_control_panel.alarm_arm_home
              target:
                entity_id: alarm_control_panel.abode_alarm
          disarm:
            - action: alarm_control_panel.alarm_disarm
              target:
                entity_id: alarm_control_panel.abode_alarm

  automation:
    - id: alarm_wrapper_sync
      alias: Wrapped Alarm Sync
      description: ""
      triggers:
        - event_type: abode_arm
          event_data: {}
          trigger: event
          enabled: true
          id: arming
        - event_type: abode_arm_fault
          event_data: {}
          trigger: event
          enabled: true
          id: arming
        - event_type: abode_disarm
          event_data: {}
          trigger: event
          enabled: true
          id: disarm
        - trigger: state
          entity_id:
            - alarm_control_panel.abode_alarm
          from: null
          to: null
          id: state_change
        - trigger: homeassistant
          event: start
          id: ha_start
      conditions: []
      actions:
        - variables:
            # 6055: Arming Away w/ Fault
            # 6064: Arming Home w/ Fault
            new_state: |
              {% if trigger.id == "arming" %}
                {% if trigger.event.data.event_code == "6055" or trigger.event.data.event_code == "6065" %}
                  arming
                {% endif %}
              {% elif trigger.id == "disarm" %}
                disarmed
              {% elif trigger.id == "state_change" %}
                {{ trigger.to_state.state }}
              {% else %}
                {{ states("alarm_control_panel.abode_alarm") }}
              {% endif %}
        - condition: template
          value_template: '{{ new_state != "" }}'
        - action: input_text.set_value
          target:
            entity_id: input_text.alarm_state
          data:
            value: "{{ new_state }}"
      mode: single

  input_text:
    alarm_state:
      name: Alarm State
      initial: Unknown
