garage_wrapper:
  homeassistant:
    customize:
      package.node_anchors:
        customize: &customize
          package: "garage_wrapper"

      cover.left_garage_door:
        <<: *customize

      cover.right_garage_door:
        <<: *customize

      input_text.left_garage_state:
        <<: *customize

      input_text.right_garage_state:
        <<: *customize

  template:
    - cover:
        - unique_id: 361f95e8-09b3-4e9b-bdeb-f99b8e743df6
          device_class: garage
          name: Left Garage Door
          state: '{{ states("input_text.left_garage_state") }}'
          open_cover:
            - condition: state
              state:
                - closed
              entity_id: cover.abode_left_garage_door
            - action: abode.trigger_automation
              metadata: {}
              data:
                entity_id: switch.open_left_garage
          close_cover:
            - condition: state
              state:
                - open
              entity_id: cover.abode_left_garage_door
            - action: abode.trigger_automation
              metadata: {}
              data:
                entity_id: switch.close_left_garage
          stop_cover:
            - action: cover.stop_cover
              target:
                entity_id: cover.abode_left_garage_door

        - unique_id: b27b2e53-f414-4428-9050-db12cc5775a1
          device_class: garage
          name: Right Garage Door
          state: '{{ states("input_text.right_garage_state") }}'
          open_cover:
            - condition: state
              state:
                - closed
              entity_id: cover.abode_right_garage_door
            - action: abode.trigger_automation
              metadata: {}
              data:
                entity_id: switch.open_right_garage
          close_cover:
            - condition: state
              state:
                - open
              entity_id: cover.abode_right_garage_door
            - action: abode.trigger_automation
              metadata: {}
              data:
                entity_id: switch.close_right_garage
          stop_cover:
            - action: cover.stop_cover
              target:
                entity_id: cover.abode_right_garage_door

  automation:
    - id: garage_wrapper_sync
      alias: Wrapped Garage Sync
      description: ""
      triggers:
        - event_type: abode_automation
          event_data: {}
          trigger: event
          enabled: true
          id: automation
        - event_type: abode_device
          event_data: {}
          trigger: event
          enabled: true
          id: device
        - trigger: homeassistant
          event: start
          id: ha_start
      conditions: []
      actions:
        - if:
            - condition: trigger
              id:
                - ha_start
          then:
            - action: input_text.set_value
              target:
                entity_id: input_text.left_garage_state
              data:
                value: '{{ states("cover.abode_left_garage_door") }}'
            - action: input_text.set_value
              target:
                entity_id: input_text.right_garage_state
              data:
                value: '{{ states("cover.abode_right_garage_door") }}'
          else:
            - variables:
                garage_door: |
                  {% if 'Right' in trigger.event.data.device_name %}
                    right
                  {% else %}
                    left
                  {% endif %}
                new_state: |
                  {% if trigger.id == "automation" %}
                    {% if 'Open' in trigger.event.data.device_name %}
                      opening
                    {% else %}
                      closing
                    {% endif %}
                  {% elif trigger.id == "device" %}
                    {% if trigger.event.data.event_code == '5150' %}
                      open
                    {% elif trigger.event.data.event_code == '5151' %}
                      closed
                    {% endif %}
                  {% else %}
                    {{ states("cover.abode_" ~ garage_door ~ "_garage_door") }}
                  {% endif %}
            - condition: template
              value_template: '{{ new_state != "" }}'
            - action: input_text.set_value
              target:
                entity_id: "input_text.{{ garage_door }}_garage_state"
              data:
                value: "{{ new_state }}"
      mode: single

  input_text:
    left_garage_state:
      name: Left garage state
      initial: None

    right_garage_state:
      name: Right garage state
      initial: None
