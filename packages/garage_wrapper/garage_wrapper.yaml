garage_wrapper:
  homeassistant:
    customize:
      package.node_anchors:
        customize: &customize
          package: "garage_wrapper"

      cover.wrapped_left_garage:
        <<: *customize

      input_boolean.left_garage_moving:
        <<: *customize

      input_boolean.right_garage_moving:
        <<: *customize

  cover:
    - platform: template
      covers:
        wrapped_left_garage:
          device_class: garage
          friendly_name: Left Garage Door
            # Need to wait for 2021.5 for this to work
            # {% if is_state("input_boolean.left_garage_moving", "on") %} 
            #   {{ "closing" if is_state("cover.left_garage_door", "open") else "opening" }}
            # {% else %}
            #   {{ states("cover.left_garage_door")  }}
            # {% endif %}
          value_template: >
            {{ states("cover.left_garage_door")  }}
          open_cover:
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.left_garage_moving
            - service: cover.open_cover
              target:
                entity_id: cover.left_garage_door
            - wait_template: >
                {{ is_state("cover.left_garage_door", "open") or is_state("input_boolean.left_garage_moving", "off")}}
              continue_on_timeout: true
              timeout: "00:01:00"
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.left_garage_moving
          close_cover:
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.left_garage_moving
            - service: cover.close_cover
              target:
                entity_id: cover.left_garage_door
            - wait_template: >
                {{ is_state("cover.left_garage_door", "closed") or is_state("input_boolean.left_garage_moving", "off")}}
              continue_on_timeout: true
              timeout: "00:01:00"
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.left_garage_moving
          stop_cover:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.left_garage_moving
            - service: cover.stop_cover
              target:
                entity_id: cover.left_garage_door

  input_boolean:
    left_garage_moving:
      name: Left garage moving
      initial: false

    right_garage_moving:
      name: Right garage moving
      initial: false
